<style lang="less">
  .header-view {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 10px 12px 0 12px;
  }

  .header-img {
    width: 60rpx;
    height: 60rpx;
    overflow: hidden;
    border-radius: 50%;
    margin-right: 5px;
  }

  .slide-image {
    width: 100%;
  }

  .padding-view {
    padding: 10px 12px;
  }

  .cover-view {
    display: flex;
    align-items: center;
    justify-content: center;
    max-height: 700rpx;
    overflow: hidden;
  }

  .cover-img {
    width: 100%;
  }

  .footer {
    width: 100%;
    margin: 30px 0 20px 0;
  }

  .logo-img {
    width: 60rpx;
    height: 60rpx;
    margin-right: 10rpx;
  }

</style>

<template>
  <view class="container" style="background: #fff">
    <scroll-view scroll-y enable-back-to-top style="height: 100vh;">
      <view class="cover-view">
        <image lazy-load class="cover-img" src="{{voteDetail.cover}}" mode="widthFix"/>
      </view>

      <timerCounterDown :beginCounter.sync="counter"/>

      <repeat for="{{player.album}}" key="index" index="index" item="item">
        <view class="padding-view">
          <image lazy-load src="{{item}}" class="slide-image" mode="widthFix"/>
        </view>
      </repeat>

      <view class="header-view">
        <image lazy-load class="header-img" src="{{player.album[0]}}" mode="aspectFill"/>
        <text class="zan-font-18 zan-font-bold">{{player.name}}</text>
      </view>

      <view class="padding-view">
        <view>
          <text class="zan-font-16">{{player.declaration}}</text>
        </view>
      </view>

      <view style="margin-top: 10px">
        <playerStat :number.sync="number" :voteNum.sync="voteNum" :giftNum.sync="giftNum" :pv.sync="pv"/>
      </view>

      <view wx:if="{{enablePresent}}" class="padding-view">
        <recvGifts :playerId.sync="playerId"/>
      </view>

      <buyGiftTip :number.sync="number" :playerId.sync="playerId" :playerName.sync="playerName" :cover.sync="cover"/>

      <navigator class="footer" url="/pages/vote/contact">
        <view style="display: flex; align-items: center; justify-content: center; margin-bottom: 5px">
          <image lazy-load class="logo-img" src="/asset/png/logo.png" />
          <text class="zan-font-14 zan-font-bold zan-c-gray-dark">小吉互动</text>
        </view>
        <view style="display: flex; align-items: center; justify-content: center">
          <text class="zan-font-14 zan-c-gray-dark">本活动由小吉互动提供技术支持</text>
        </view>
      </navigator>

      <view style="height: 180rpx; background: transparent"/>

      <playerToolbar :voteId.sync="voteId" :scene.sync="scene" :enablePresent.sync="enablePresent"/>
    </scroll-view>
  </view>
</template>

<script>
  import wepy from 'wepy'
  import vote from '../../cloud/vote'
  import Tips from '../../utils/Tips'
  import PlayerStat from '../../components/playerStat'
  import PlayerToolbar from '../../components/playerToolbar'
  import * as errno from '../../utils/errno'
  import BuyGiftTip from '../../components/buyGiftTip'
  import RecvGifts from '../../components/recvGifts'
  import TimerCounterDown from '../../components/timerCountDown'

  export default class PlayerPage extends wepy.page {
    config = {
      enablePullDownRefresh: true
    }

    data = {
      voteId: null,
      voteDetail: null,
      playerId: null,
      player: null,
      cover: null,
      number: null,
      playerName: null,
      voteNum: null,
      giftNum: null,
      pv: null,
      scene: null,
      enablePresent: false,
      counter: 0
    }

    components = {
      playerStat: PlayerStat,
      playerToolbar: PlayerToolbar,
      buyGiftTip: BuyGiftTip,
      recvGifts: RecvGifts,
      timerCounterDown: TimerCounterDown
    }

    methods = {

    }

    events = {
      'voteForPlayer': async () => {
        try {
          await vote.voteForPlayer({playerId: this.player.id})
          this.voteNum += 1
          this.$parent.reloadActiveVote()
          this.$apply()
          Tips.success('投票成功')
          if (this.enablePresent) {
            setTimeout(() => {
              this.$invoke('buyGiftTip', 'toggleDialog', '投票成功！每天可以投一票，明天继续参与哦！')
            }, 1500)
          }
        } catch (e) {
          if (e.code === errno.ERROR_VOTE_USE_UP) {
            Tips.error('今日已投票')
            if (this.enablePresent) {
              setTimeout(() => {
                this.$invoke('buyGiftTip', 'toggleDialog', '今天的选票已经用完啦！尝试送个礼物吧！')
              }, 1500)
            }
          } else if (e.code === errno.ERROR_VOTE_WAS_DONE) {
            Tips.error('活动已结束')
          }
        }
      },

      'toPresent': () => {
        this.$navigate({url: '/pages/vote/present?playerId=' + this.player.id})
      },

      'toAbout': () => {
        this.$navigate({url: '/pages/vote/contact'})
      }
    }

    async onLoad(option) {
      let playerId = option.playerId
      this.scene = option.scene
      this.player = this.$parent.getGlobalPlayer(playerId)
      if (!this.player) {
        this.player = await vote.fetchPlayerById({playerId: playerId})
        this.voteDetail = await vote.fetchVoteInfoById({voteId: this.player.voteId, updateStatus: true})
        if (this.voteDetail) {
          wepy.$instance.globalData.activeVote = this.voteDetail
          this.enablePresent = !!this.voteDetail.enablePresent
        }

        vote.incVotePv({voteId: this.player.voteId})
      } else {
        this.voteDetail = wepy.$instance.globalData.activeVote
        if (this.voteDetail) {
          this.enablePresent = !!this.voteDetail.enablePresent
        }
      }
      this.playerId = playerId
      this.voteId = this.player.voteId
      this.cover = this.player.album[0]
      this.number = this.player.number
      this.playerName = this.player.name
      this.voteNum = this.player.voteNum
      this.giftNum = this.player.giftNum
      this.pv = this.player.pv
      this.counter = this.voteDetail.counter

      await this.$parent.getUserInfo();
      vote.incPlayerPv({playerId: playerId})

      wepy.setNavigationBarTitle({title: '给'+this.player.name+'投票'})
      this.$apply()
    }

    onShow() {
      this.$invoke('buyGiftTip', 'hideDialog')
    }

    onPullDownRefresh() {
      this.refreshPlayerGifts()
    }

    onShareAppMessage () {
      let voteInfo = wepy.$instance.globalData.activeVote
      const title = this.player.number + '号 ' + this.player.name + ' ' + voteInfo.title + '，邀请您参与投票';
      const url = '/pages/vote/player?playerId=' + this.player.id + '&scene=share';
      return Tips.share(title, url, title, this.cover);
    }

    async refreshPlayerGifts() {
      this.player = await vote.fetchPlayerById({playerId: this.playerId})
      this.voteId = this.player.voteId
      this.number = this.player.number
      this.voteNum = this.player.voteNum
      this.giftNum = this.player.giftNum
      this.pv = this.player.pv
      this.$invoke('recvGifts', 'refreshRecvGifts')
      this.$apply()
    }
  }
</script>
